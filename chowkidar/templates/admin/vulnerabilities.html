{% extends "layout.html" %}
{% block content %}

<div class="pt-1">
    <div class="mt-0 md:mt-10 shadow-lg rounded-lg">
        <table class="w-full table-fixed">
            <thead>
                <tr class="bg-blue-100">
                    <th class="w-2/4 py-4 px-2 md:px-6 text-left text-gray-600 font-bold uppercase">
                        <div class="flex">
                            <span class="whitespace-nowrap lg:hidden">
                                Name
                            </span>
                            <span class="whitespace-nowrap hidden lg:flex">
                                Vulnerability Name
                            </span>
                            <div class="relative mx-3 w-full hidden lg:flex">
                                <div class="start-0 flex items-center ">
                                    <svg class="absolute flex-shrink-0 w-7 h-7" viewBox="0 -0.5 25 25" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g>
                                        <g id="SVGRepo_iconCarrier"> 
                                            <path fill-rule="evenodd" clip-rule="evenodd" d="M11.132 9.71395C10.139 11.2496 10.3328 13.2665 11.6 14.585C12.8468 15.885 14.8527 16.0883 16.335 15.065C16.6466 14.8505 16.9244 14.5906 17.159 14.294C17.3897 14.0023 17.5773 13.679 17.716 13.334C18.0006 12.6253 18.0742 11.8495 17.928 11.1C17.7841 10.3573 17.4268 9.67277 16.9 9.12995C16.3811 8.59347 15.7128 8.22552 14.982 8.07395C14.2541 7.92522 13.4982 8.00197 12.815 8.29395C12.1254 8.58951 11.5394 9.08388 11.132 9.71395Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path> 
                                            <path d="M17.5986 13.6868C17.2639 13.4428 16.7947 13.5165 16.5508 13.8513C16.3069 14.1861 16.3806 14.6552 16.7154 14.8991L17.5986 13.6868ZM19.0584 16.6061C19.3931 16.85 19.8623 16.7764 20.1062 16.4416C20.3501 16.1068 20.2764 15.6377 19.9416 15.3938L19.0584 16.6061ZM7.5 12.7499C7.91421 12.7499 8.25 12.4142 8.25 11.9999C8.25 11.5857 7.91421 11.2499 7.5 11.2499V12.7499ZM5.5 11.2499C5.08579 11.2499 4.75 11.5857 4.75 11.9999C4.75 12.4142 5.08579 12.7499 5.5 12.7499V11.2499ZM7.5 15.7499C7.91421 15.7499 8.25 15.4142 8.25 14.9999C8.25 14.5857 7.91421 14.2499 7.5 14.2499V15.7499ZM5.5 14.2499C5.08579 14.2499 4.75 14.5857 4.75 14.9999C4.75 15.4142 5.08579 15.7499 5.5 15.7499V14.2499ZM8.5 9.74994C8.91421 9.74994 9.25 9.41415 9.25 8.99994C9.25 8.58573 8.91421 8.24994 8.5 8.24994V9.74994ZM5.5 8.24994C5.08579 8.24994 4.75 8.58573 4.75 8.99994C4.75 9.41415 5.08579 9.74994 5.5 9.74994V8.24994ZM16.7154 14.8991L19.0584 16.6061L19.9416 15.3938L17.5986 13.6868L16.7154 14.8991ZM7.5 11.2499H5.5V12.7499H7.5V11.2499ZM7.5 14.2499H5.5V15.7499H7.5V14.2499ZM8.5 8.24994H5.5V9.74994H8.5V8.24994Z" fill="currentColor"></path> 
                                        </g>
                                    </svg>
                                    <input id="search-audit" class="mx-3 pl-4 font-normal peer block w-72 bg-transparent border-t-transparent border-b-2 border-x-transparent border-b-gray-500 text-sm focus:outline-none focus:border-t-transparent focus:border-r-transparent focus:border-l-transparent focus:border-b-indigo-500" placeholder="Vulnerability Name / Severity">
                                </div>
                            </div>
                        </div>
                    </th>
                    <th class="w-1/4 py-4 px-2 md:px-6 text-left md:text-center text-gray-600 font-bold uppercase">severity</th>
                    <th class="w-2/4 md:w-1/4 py-4 px-4 text-left md:text-center text-gray-600 font-bold uppercase">
                        <div class="flex w-full justify-between relative">
                            <div class="flex-grow">
                                <span class="hidden lg:flex pl-32">CVSS</span>
                            </div>
                            <span class="md:hidden">CVSS</span>
                            <div class="flex items-center justify-center -mt-1 mx-2 p-1 bg-blue-300 rounded-md group">
                                <a href="{{ url_for('admin_view.admin_scan_result', user_email=audit.Auditor.email, audit_name=audit.name) }}" type="submit">
                                    <svg class="w-6 h-6" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"> <path d="M22 9H2M6 17.5L8.5 15L6 12.5M11 17.5L15 17.5M2 7.8L2 16.2C2 17.8802 2 18.7202 2.32698 19.362C2.6146 19.9265 3.07354 20.3854 3.63803 20.673C4.27976 21 5.11984 21 6.8 21H17.2C18.8802 21 19.7202 21 20.362 20.673C20.9265 20.3854 21.3854 19.9265 21.673 19.362C22 18.7202 22 17.8802 22 16.2V7.8C22 6.11984 22 5.27977 21.673 4.63803C21.3854 4.07354 20.9265 3.6146 20.362 3.32698C19.7202 3 18.8802 3 17.2 3L6.8 3C5.11984 3 4.27976 3 3.63803 3.32698C3.07354 3.6146 2.6146 4.07354 2.32698 4.63803C2 5.27976 2 6.11984 2 7.8Z" stroke="#000000" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path> </g></svg>
                                </a>
                                <div class='absolute hidden group-hover:block mt-20 bg-black rounded-md p-1 px-2 action-triangle-top'>
                                    <span class='text-white text-xs normal-case font-normal whitespace-nowrap'>Scan Result</span>
                                </div>
                            </div>
                            {% if audit.status == 'finished' %}
                            <div class="flex items-center justify-center -mt-1 p-1 bg-blue-300 rounded-md group" id="generate-report">
                                <button class="download-icon">
                                    <svg class="w-6 h-6" id="download-icon-svg" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <g id="SVGRepo_bgCarrier" stroke-width="0"></g>
                                        <g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g>
                                        <g id="SVGRepo_iconCarrier">
                                            <path d="M17 17H17.01M17.4 14H18C18.9319 14 19.3978 14 19.7654 14.1522C20.2554 14.3552 20.6448 14.7446 20.8478 15.2346C21 15.6022 21 16.0681 21 17C21 17.9319 21 18.3978 20.8478 18.7654C20.6448 19.2554 20.2554 19.6448 19.7654 19.8478C19.3978 20 18.9319 20 18 20H6C5.06812 20 4.60218 20 4.23463 19.8478C3.74458 19.6448 3.35523 19.2554 3.15224 18.7654C3 18.3978 3 17.9319 3 17C3 16.0681 3 15.6022 3.15224 15.2346C3.35523 14.7446 3.74458 14.3552 4.23463 14.1522C4.60218 14 5.06812 14 6 14H6.6M12 15V4M12 15L9 12M12 15L15 12" stroke="#000000" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
                                        </g>
                                    </svg>
                                    <svg class="w-6 h-6 spinner hidden" id="loading-icon-svg" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <g id="SVGRepo_bgCarrier" stroke-width="0"></g>
                                        <g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g>
                                        <g id="SVGRepo_iconCarrier">
                                            <path d="M20.0001 12C20.0001 13.3811 19.6425 14.7386 18.9623 15.9405C18.282 17.1424 17.3022 18.1477 16.1182 18.8587C14.9341 19.5696 13.5862 19.9619 12.2056 19.9974C10.825 20.0328 9.45873 19.7103 8.23975 19.0612" stroke="#000000" stroke-width="3.55556" stroke-linecap="round"></path>
                                        </g>
                                    </svg>
                                </button>
                                <div class='absolute hidden group-hover:block mt-20 bg-black rounded-md p-1 px-2 action-triangle-top'>
                                    <span class='text-white text-xs normal-case font-normal whitespace-nowrap'>Generate Report</span>
                                </div>
                            </div>
                            {% endif %}
                        </div>
                     </th>
                </tr>
            </thead>
        </table>
        <div class="w-full scrollable-table rounded-lg">
            <table class="w-full table-fixed" id="audit-list">
                <tbody class="bg-white">
                    {% for vulnerability in vulnerabilities %}
                    <tr>
                        <td class="w-1/3 md:w-2/4 py-4 px-2 md:px-6 border-b border-gray-200 capitalize">
                            <a href="{{ url_for('admin_view.admin_vulnerability', user_email=audit.Auditor.email, audit_name=audit.name, vulnerability_name=vulnerability.name) }}">
                                <p class="group inline-block">
                                    <span class="relative inline-block transition-all duration-300">{{ vulnerability.name }}
                                      <span class="absolute inset-x-0 bottom-0 h-0.5 bg-indigo-300 w-0 transition-all duration-300 group-hover:w-full"></span>
                                    </span>
                                  </p>
                            </a>
                        </td>
                        <td class="w-1/4 py-4 px-2 md:px-6 border-b border-gray-200 text-center">
                            {% if vulnerability.Template.severity == 'CRITICAL' %}
                                <span class="px-2 inline-flex text-sm leading-5 font-semibold rounded-full bg-red-400 text-red-950">{{ vulnerability.Template.severity }}</span>
                            {% elif vulnerability.Template.severity == 'HIGH' %}
                                <span class="px-2 inline-flex text-sm leading-5 font-semibold rounded-full bg-red-300 text-red-800">{{ vulnerability.Template.severity }}</span>
                            {% elif vulnerability.Template.severity == 'MEDIUM' %}
                                <span class="px-2 inline-flex text-sm leading-5 font-semibold rounded-full bg-orange-300 text-orange-800">{{ vulnerability.Template.severity }}</span>
                            {% elif vulnerability.Template.severity == 'LOW' %}
                                <span class="px-2 inline-flex text-sm leading-5 font-semibold rounded-full bg-yellow-200 text-yellow-800">{{ vulnerability.Template.severity }}</span>
                            {% elif vulnerability.Template.severity == 'INFO' %}
                                <span class="px-2 inline-flex text-sm leading-5 font-semibold rounded-full bg-blue-200 text-blue-800">{{ vulnerability.Template.severity }}</span>
                            {% endif %}
                        </td>
                        <td class="w-1/3 md:w-1/4 py-4 px-2 md:px-6 border-b border-gray-200 truncate text-center">{{ vulnerability.Template.cvss }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    const generatePdfBtn = document.getElementById('generate-report');
    const downloadIconSvg = document.getElementById('download-icon-svg');
    const loadingIconSvg = document.getElementById('loading-icon-svg');

    const MAX_ATTEMPTS = 5; // Maximum number of attempts to fetch the download
    generatePdfBtn.addEventListener('click', () => {
        downloadIconSvg.classList.add('hidden');
        loadingIconSvg.classList.remove('hidden');
        fetch('/admin/report/{{ audit.id }}', { method: 'GET' })
            .then(response => {
            if (!response.redirected) {
                return response.text();
            } else {
                downloadIconSvg.classList.remove('hidden');
                loadingIconSvg.classList.add('hidden');
                throw new Error('Failed to generate PDF');
            }
            })
            .then(jobId => {
            let attempts = 0;
            const checkDownloadInterval = setInterval(() => {
                fetch(`/report/{{ audit.id }}/download/${jobId}`, { method: 'GET' })
                .then(response => {
                    if (response.status === 200) {
                    clearInterval(checkDownloadInterval);
                    return response.blob();
                    } else {
                    return response.text();
                    }
                })
                .then(data => {
                    if (typeof data === 'string') {
                        attempts++;
                        if (attempts >= MAX_ATTEMPTS) {
                            clearInterval(checkDownloadInterval);
                            console.log('Maximum attempts reached, terminating PDF download');
                            downloadIconSvg.classList.remove('hidden');
                            loadingIconSvg.classList.add('hidden');
                        } else {
                            console.log(data);
                        }
                    } else {
                    downloadIconSvg.classList.remove('hidden');
                    loadingIconSvg.classList.add('hidden');
                    const downloadUrl = window.URL.createObjectURL(new Blob([data]));
                    const link = document.createElement('a');
                    link.href = downloadUrl;
                    link.download = '{{ audit.name }}-report.pdf';
                    link.click();
                    }
                })
                .catch(error => console.error(error));
            }, 5000);
            })
            .catch(error => console.error(error));
        });
</script>

{% endblock content %}